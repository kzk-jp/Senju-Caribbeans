<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>フットサルメンバー組織図（D3.js）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            padding: 20px;
            background-color: #f7f7f7;
            overflow: hidden; /* bodyのデフォルトスクロールを無効化 */
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }
        .chart-container {
            width: 100%;
            height: calc(100vh - 100px); /* ヘッダーなどを考慮した高さ */
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden; /* SVGコンテナ自体は非表示 */
        }
        .node circle {
            fill: #999;
            stroke: steelblue;
            stroke-width: 3px;
            cursor: pointer; /* クリック可能であることを示す */
        }
        .node text {
            font: 12px sans-serif;
            fill: #555;
            pointer-events: none; /* テキストのクリックイベントを無効化 */
        }
        .node image {
            border-radius: 50%; /* 画像を丸くする */
            object-fit: cover; /* 画像のアスペクト比を維持 */
        }
        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }
         .loading-message {
            text-align: center;
            font-size: 1.2rem;
            color: #555;
            margin-top: 50px;
         }
    </style>
</head>
<body>

    <h1>フットサルメンバー組織図</h1>

    <div id="chart" class="chart-container">
         <p class="loading-message">データを読み込んでいます...</p>
    </div>

    <script>
        // ここをGitHubのRawtherapee URLに変更してください
        const JSON_FILE_PATH = 'tree_data.json';

        // マージンを調整してルートノードを中央寄りに配置
        const margin = { top: 20, right: 90, bottom: 30, left: 150 }; // 左マージンを増やしました
        let width = 960 - margin.left - margin.right;
        let height = 500 - margin.top - margin.bottom;

        let svg = null; // SVG要素を保持する変数
        let gLink, gNode; // リンクとノードのグループを保持

        // Zoom and Pan behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4]) // ズームの範囲
            .on('zoom', (event) => {
                svg.attr('transform', event.transform);
            });

        // Function to render the tree
        function renderTree(data) {
            // Remove loading message
            d3.select("#chart").select(".loading-message").remove();

            // Clear previous SVG if exists
            d3.select("#chart svg").remove();

            const chartContainer = document.getElementById('chart');
            const containerWidth = chartContainer.clientWidth - margin.left - margin.right;
            const containerHeight = chartContainer.clientHeight - margin.top - margin.bottom;

            width = containerWidth;
            // ノード数に基づいて適切な高さを計算（最小値を設定）
            const calculatedHeight = Math.max(containerHeight, data.length * 40); // 1ノードあたり40pxで計算
            height = calculatedHeight;


            svg = d3.select("#chart").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                 .call(zoom) // SVG全体にズームとパンを適用
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`); // マージン分移動

            gLink = svg.append("g").attr("class", "links");
            gNode = svg.append("g").attr("class", "nodes");


            // declares a tree layout and assigns the size
            const treemap = d3.tree().size([height, width]);

            // Assigns parent, children, height, depth and links
            const root = d3.stratify()
                .id(d => d.id)
                .parentId(d => d.introducerPageId)(data);

            // Assigns tree data to the root
            const nodes = treemap(root);

            // Compute the new tree layout.
            const treeNodes = nodes.descendants();
            const treeLinks = nodes.links();

            // Normalize for fixed-depth.
            treeNodes.forEach(d => { d.y = d.depth * 180 }); // Adjust horizontal spacing

            // ****************** Nodes Section ***************************

            // Update the nodes...
            const node = gNode.selectAll('g.node')
                .data(treeNodes, d => d.id || (d.id = d.data.id));

            // Enter any new nodes at the parent's previous position.
            const nodeEnter = node.enter().append('g')
                .attr('class', 'node')
                .attr("transform", d => `translate(${d.y},${d.x})`); // 横向きにするためにxとyを入れ替え

            // Add Circle for the nodes
            nodeEnter.append('circle')
                .attr('r', 20) // Adjust circle size
                .style("fill", d => d._children ? "lightsteelblue" : "#fff");

             // Add Image for the nodes
            nodeEnter.append("image")
                .attr("xlink:href", d => d.data.image ? d.data.image : 'placeholder.png') // Placeholder image if none
                .attr("x", -15) // Adjust image position relative to circle center
                .attr("y", -15)
                .attr("width", 30)
                .attr("height", 30)
                 .attr("clip-path", "circle(15px at 15px 15px)") // Clip image to circle
                 .on('error', function() { // Handle image loading errors
                     d3.select(this).remove(); // Remove image on error
                     // Append placeholder text or icon
                     d3.select(this.parentNode).append("text")
                        .attr("dy", ".35em")
                        .attr("x", 0)
                        .attr("text-anchor", "middle")
                         .style("font-size", "10px")
                        .text(d => d.data.name ? d.data.name.charAt(0) : '?');
                 });


            // Add labels for the nodes (Name)
            nodeEnter.append('text')
                .attr("dy", ".35em")
                .attr("x", 30) // Adjust text position
                .attr("text-anchor", "start")
                .text(d => d.data.name);

            // Add labels for the nodes (Introducer Name)
             nodeEnter.append('text')
                .attr("dy", "1.8em") // Position below the name (少し下げました)
                .attr("x", 30) // Adjust text position
                .attr("text-anchor", "start")
                .style("font-size", "10px")
                .style("fill", "#777")
                .text(d => d.data.introducer_name ? `紹介者: ${d.data.introducer_name}` : '');


            // ****************** Links Section ***************************

            // Update the links...
            const link = gLink.selectAll('path.link')
                .data(treeLinks, d => d.target.id);

            // Enter any new links at the parent's previous position.
            link.enter().insert('path', "g")
                .attr("class", "link")
                .attr('d', d => {
                    // リンクのパスを少し調整して角を丸く見せる
                    return "M" + d.source.y + "," + d.source.x
                        + "C" + (d.source.y + (d.target.y - d.source.y) / 2) + "," + d.source.x
                        + " " + (d.source.y + (d.target.y - d.source.y) / 2) + "," + d.target.x
                        + " " + d.target.y + "," + d.target.x;
                });
        }

        // Fetch JSON data from GitHub
        fetch(JSON_FILE_PATH)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(jsonData => {
                // データ取得成功後にツリーを構築・表示
                renderTree(jsonData);
            })
            .catch(error => {
                // データ取得失敗時のエラー表示
                console.error('Error fetching JSON data:', error);
                d3.select("#chart").html('<p class="loading-message">データの読み込みに失敗しました。GitHubのRawtherapee URLが正しいか、またはCORSの問題がないか確認してください。</p>');
            });

         // Optional: Add responsiveness on window resize
        window.addEventListener('resize', () => {
            // Re-fetch data or use cached data to re-render
             fetch(JSON_FILE_PATH)
                .then(response => response.json())
                .then(jsonData => {
                    renderTree(jsonData);
                })
                .catch(error => {
                    console.error('Error fetching JSON data on resize:', error);
                });
        });

    </script>

</body>
</html>
