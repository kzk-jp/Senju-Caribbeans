<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>フットサルメンバー組織図（上から下）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            padding: 20px;
            background-color: #f7f7f7;
            overflow: hidden; /* bodyのデフォルトスクロールを無効化 */
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }
        .chart-container {
            width: 100%;
            height: calc(100vh - 100px); /* ヘッダーなどを考慮した高さ */
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden; /* SVGコンテナ自体は非表示 */
        }
        .node circle {
            fill: #999;
            stroke: steelblue;
            stroke-width: 3px;
            cursor: pointer; /* クリック可能であることを示す */
        }
        .node text {
            font: 10px sans-serif; /* フォントサイズを小さく */
            fill: #555;
            pointer-events: none; /* テキストのクリックイベントを無効化 */
        }
        .node image {
            border-radius: 50%; /* 画像を丸くする */
            object-fit: cover; /* 画像のアスペクト比を維持 */
        }
        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px; /* 線の太さを少し細く */
        }
         .loading-message {
            text-align: center;
            font-size: 1.2rem;
            color: #555;
            margin-top: 50px;
         }
         .error-message {
             text-align: center;
             font-size: 1.2rem;
             color: red;
             margin-top: 50px;
         }
    </style>
</head>
<body>

    <h1>フットサルメンバー組織図</h1>

    <div id="chart" class="chart-container">
         <p class="loading-message">データを読み込んでいます...</p>
    </div>

    <script>
        // ここをGitHubのRawtherapee URLに変更してください
        // 例: https://raw.githubusercontent.com/ユーザー名/リポジトリ名/ブランチ名/tree_data.json
        const JSON_FILE_PATH = 'tree_data.json';

        // マージンを調整
        const margin = { top: 40, right: 20, bottom: 20, left: 20 }; // 上マージンを増やし、左右を減らしました
        let width = 960 - margin.left - margin.right;
        let height = 500 - margin.top - margin.bottom;

        let svg = null; // SVG要素を保持する変数
        let gLink, gNode; // リンクとノードのグループを保持

        // Zoom and Pan behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4]) // ズームの範囲
            .on('zoom', (event) => {
                svg.attr('transform', event.transform);
            });

        // Function to render the tree
        function renderTree(data) {
            // Remove loading message
            d3.select("#chart").select(".loading-message").remove();

            // Clear previous SVG if exists
            d3.select("#chart svg").remove();

            const chartContainer = document.getElementById('chart');
            const containerWidth = chartContainer.clientWidth - margin.left - margin.right;
            const containerHeight = chartContainer.clientHeight - margin.top - margin.bottom;

            width = containerWidth;
            // ノード数に基づいて適切な高さを計算（最小値を設定）
             // 上から下向きの場合、高さはノードの深さに依存
            const maxDepth = d3.max(data, d => {
                 let depth = 0;
                 let current = d;
                 while(current && current.introducerPageId) {
                     const parent = data.find(p => p.id === current.introducerPageId);
                     if (parent) {
                         depth++;
                         current = parent;
                     } else {
                         break; // 循環参照などを避ける
                     }
                 }
                 return depth;
            });
            const calculatedHeight = Math.max(containerHeight, (maxDepth + 1) * 80); // 深さに基づいて高さを計算 (1レベルあたり80px)
            height = calculatedHeight;


            svg = d3.select("#chart").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                 .call(zoom) // SVG全体にズームとパンを適用
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`); // マージン分移動

            gLink = svg.append("g").attr("class", "links");
            gNode = svg.append("g").attr("class", "nodes");


            // declares a tree layout and assigns the size
            // レイアウトの向きを上から下に変更 (サイズを [width, height] に)
            const treemap = d3.tree().size([width, height]);

            // Assigns parent, children, height, depth and links
            const root = d3.stratify()
                .id(d => d.id)
                .parentId(d => d.introducerPageId)(data);

            // Assigns tree data to the root
            const nodes = treemap(root);

            // Compute the new tree layout.
            const treeNodes = nodes.descendants();
            const treeLinks = nodes.links();

            // Normalize for fixed-depth. (上から下向きの場合はx座標が深さに依存)
            treeNodes.forEach(d => { d.y = d.depth * 80 }); // 垂直方向の間隔を調整 (1レベルあたり80px)

            // ****************** Nodes Section ***************************

            // Update the nodes...
            const node = gNode.selectAll('g.node')
                .data(treeNodes, d => d.id || (d.id = d.data.id));

            // Enter any new nodes at the parent's previous position.
            const nodeEnter = node.enter().append('g')
                .attr('class', 'node')
                // ノードの座標を上から下向きに変更 (xとyを入れ替え)
                .attr("transform", d => `translate(${d.x},${d.y})`);

            // Add Circle for the nodes
            nodeEnter.append('circle')
                .attr('r', 20) // Adjust circle size
                .style("fill", d => d._children ? "lightsteelblue" : "#fff");

             // Add Image for the nodes
            nodeEnter.append("image")
                .attr("xlink:href", d => d.data.image ? d.data.image : 'placeholder.png') // Placeholder image if none
                .attr("x", -15) // Adjust image position relative to circle center
                .attr("y", -15)
                .attr("width", 30)
                .attr("height", 30)
                 .attr("clip-path", "circle(15px at 15px 15px)") // Clip image to circle
                 .on('error', function() { // Handle image loading errors
                     d3.select(this).remove(); // Remove image on error
                     // Append placeholder text or icon
                     d3.select(this.parentNode).append("text")
                        .attr("dy", ".35em")
                        .attr("x", 0)
                        .attr("text-anchor", "middle")
                         .style("font-size", "10px")
                        .text(d => d.data.name ? d.data.name.charAt(0) : '?');
                 });


            // Add labels for the nodes (Name)
            nodeEnter.append('text')
                .attr("dy", "2.2em") // 画像の下に配置
                .attr("x", 0) // 中央揃え
                .attr("text-anchor", "middle") // 中央揃え
                .text(d => d.data.name);

            // Add labels for the nodes (Introducer Name)
             nodeEnter.append('text')
                .attr("dy", "3.2em") // 名前の下に配置
                .attr("x", 0) // 中央揃え
                .attr("text-anchor", "middle") // 中央揃え
                .style("font-size", "8px") // さらに小さく
                .style("fill", "#777")
                .text(d => d.data.introducer_name ? `紹介者: ${d.data.introducer_name}` : '');


            // ****************** Links Section ***************************

            // Update the links...
            const link = gLink.selectAll('path.link')
                .data(treeLinks, d => d.target.id);

            // Enter any new links at the parent's previous position.
            link.enter().insert('path', "g")
                .attr("class", "link")
                .attr('d', d => {
                    // リンクのパスを上から下向きに変更
                    return "M" + d.source.x + "," + d.source.y
                        + "C" + d.source.x + "," + (d.source.y + d.target.y) / 2
                        + " " + d.target.x + "," + (d.source.y + d.target.y) / 2
                        + " " + d.target.x + "," + d.target.y;
                });
        }

        // Fetch JSON data from GitHub
        fetch(JSON_FILE_PATH)
            .then(response => {
                if (!response.ok) {
                    // レスポンスがOKでない場合エラー
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                // レスポンスのContent-Typeを確認する（簡易的なチェック）
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                     throw new Error(`Invalid content type: ${contentType}. Please ensure the URL points to the raw JSON file.`);
                }
                return response.json();
            })
            .then(jsonData => {
                // データ取得成功後にツリーを構築・表示
                renderTree(jsonData);
            })
            .catch(error => {
                // データ取得失敗時のエラー表示
                console.error('Error fetching JSON data:', error);
                d3.select("#chart").html('<p class="error-message">データの読み込みに失敗しました。<br>原因として以下が考えられます:<br>1. GitHubの**Rawtherapee URL**が正しく指定されていません。<br>2. CORS (Cross-Origin Resource Sharing) の問題が発生しています（GitHub Pagesからのアクセスをお試しください）。<br>3. JSONファイルの内容に誤りがある可能性があります。</p>');
            });

         // Optional: Add responsiveness on window resize
        window.addEventListener('resize', () => {
             // ウィンドウサイズ変更時は、現在のデータで再描画を試みる
             // 必要であれば、再度fetchすることも検討
             const chartContainer = document.getElementById('chart');
             // エラーメッセージが表示されていないか確認
             if (!chartContainer.querySelector('.error-message')) {
                // エラーがない場合のみ再描画を試みる（パフォーマンスに注意）
                 // ここでは簡易的にリロードしていますが、データキャッシュと再描画関数を呼ぶ方が効率的です
                 // window.location.reload();
                 // または、取得済みのjsonDataを使ってrenderTreeを呼び出す
                 // renderTree(cachedJsonData); // cachedJsonDataを適切に保持する必要あり
             }
        });

    </script>

</body>
</html>
